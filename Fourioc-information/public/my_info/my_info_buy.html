<!DOCTYPE html>
<html>
<head>
    <title>续费购买</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <meta name="description" content="">

    <link rel="stylesheet" href="../jquery_weui/weui.min.css">
    <link rel="stylesheet" href="../jquery_weui/jquery-weui.css">
    <link rel="stylesheet" href="../jquery_weui/demos.css">

    <script src="../common/common_func.js"></script>
    <link rel="stylesheet" href="../common/common_style.css">

    <script src="../jquery_weui/jquery-2.1.4.js"></script>
    <script src="../jquery_weui/jquery-weui.js"></script>

    <script src="../common/spinner/jquery.spinner.js"></script>
    <link rel="stylesheet" href="../common/spinner/jquery.spinner.css">

    <style>
      .grey_font{color:grey;}
      .blue_font{color:rgb(87,107,149);}


      .font_3{font-size:30%;}
      .font_4{font-size:40%;}
      .font_5{font-size:50%;}
      .font_6{font-size:60%;}
      .font_7{font-size:70%;}
      .font_8{font-size:80%;}
      .font_9{font-size:90%;}
      .font_10{font-size:120%;font-weight:bold;}
      .font_20{font-size:200%;}
      .font_30{font-size:300%;}

      .mask {       
            position: absolute; 
            top: 0px; 
            left: 0px;     
            filter: alpha(opacity=85); /* IE的透明度 */
            background-color: #555;     
            z-index: 1002; 
            opacity:0.85; /* 透明度 */
            -moz-opacity:0.85;     
      }
      .keyboard_pos{ 
        position:fixed;
        left:0%;
        /*top:50%;*/
        bottom:0%;
        /*margin-left:width/2;*/
        /*margin-top:height/2;*/
        width: 100%;
        /*height: 40%;*/
        /*background:rgb(0,0,0);*/
        /*color:#000;*/
      }     
      .pwd_pos{ 
        position:fixed;
        left:10%;
        top:10%;
        /*margin-left:width/2;*/
        /*margin-top:height/2;*/
        width: 80%;
        /*height: 40%;*/
        /*background:rgb(0,0,0);*/
        /*color:#000;*/
      }
      .grid_height{
        height:40px;
        padding-top:10px;
      }
    </style>

    <script>
        var g_timer = null;
        var g_pwd = '';
        var g_products_info = null;

        $(function(){

            var req_json = {
            };

            $.ajax({
              dataType:'json',
              contentType: "application/json",
              type: 'get', // 提交方式 get/post
              url: '/api/v1/personal_info/products', // 需要提交的 url
              data: JSON.stringify(req_json),
              async: false,
              beforeSend: function(XHR) {
              },
              success: function(data) { // data 保存提交后返回的数据，一般为 json 数据
                // alert("data:" + JSON.stringify(data));
                if( typeof data == "object" ) {
                    if( data.success == 0 ) {
                        g_products_info = data;
                    } else {
                        debug_trace("personal_info/products success [" + data.success + "] desc" + data.desc);
                        // window.location = '../common/invalid.html?msg=' + encodeURI(encodeURI('取得任务数据失败，无法取得数据'));
                    }
                } else {
                    debug_trace("personal_info/products error");
                    // window.location = '../common/invalid.html?msg=' + encodeURI(encodeURI('取得任务数据失败，格式错误'));
                }
              },
              error:function(XHR, ErrText, Exception) {
                debug_trace("personal_info/products failure.");
                // window.location = '../common/invalid.html?msg=' + encodeURI(encodeURI('取得任务数据失败，服务器连接错误'));
              }
            });
        });

    </script>
</head>

<body ontouchstart bgcolor="#EFEFF4">

    <!-- <div id="all_tab" class="weui_tab" style="display:none;"> -->
    <div id="all_tab" class="weui_tab">
        <div class="weui_tab_bd">

            <div class="weui_cells_title">已购买过的产品</div>
            <div id="own_container" class="weui_panel">
            </div>

            <div class="weui_cells_title">所有产品</div>
            <div id="all_container" class="weui_panel">
            </div>

            <!-- 完整样式 -->
        <!--     <div class="weui_panel">
                <div class="weui_panel_bd">
                    <div class="weui_media_box weui_media_appmsg">
                        <div class="weui_media_hd">
                            <img id="create_person_pic" class="weui_media_appmsg_thumb" src="" alt="head">
                        </div>
                        <div class="weui_media_bd">
                            <h4 class="weui_media_desc ">
                                <span id="edit_time">人教微课产品包</span>
                            </h4>
                            <p class="weui_media_desc ">
                                <span id="edit_time">教科书同步名师讲堂</span>
                            </p>
                            <br>
                        </div>
                        <div class="weui_media_bd" style="margin-left:0px;border-left:0px;padding-left:0px;">
                            <p class="weui_media_desc ">
                                <span id="edit_time">1月包</span>
                            </p>
                            <br>
                            <p class="weui_media_desc" style="text-align:right;">
                                <span id="edit_time">¥ 50元</span>
                            </p>
                        </div>
                    </div>
                    <div class="weui_media_box weui_media_appmsg">
                        <div class="weui_media_bd" style="text-align:left;">
                            <p class="weui_media_desc ">
                                <span id="edit_time">2016-10-10 到期</span>
                            </p>
                        </div>
                        <div class="weui_cell_ft">
                            <input type="text" class="spinner"/>
                        </div>
                    </div>
                </div>
            </div> -->


            <br>
            <br>
            <br>
            <br>
            <br>
            <br>
            <br>
            <br>
            <br>
            <br>
            <br>
            <br>
            <br>
            <br>
            <br>
            <br>
            <br>
            <br>
            <br>
            <br>
            <br>
            <br>
            <br>
            <br>
            <br>
        </div>

        <div class="weui_tabbar">
            <div class="weui_tabbar_item">
                <a id="notify_no_view" href="javascript:send_pay();" class="weui_btn weui_btn_warn" style="margin:10px;">支付</a>
            </div>
        </div>
    </div>


<!--     <div id="mask" class="mask" style="display:none;"></div>    

    <div id="keyboard" class="keyboard_pos" style="display:none;background:white;z-index:1003;">
        <div class="weui_grids">
            <a id="kb_1" href="javascript:on_numKey(1);" class="weui_grid js_grid grid_height">
                <p class="weui_grid_label font_10">1</p>
            </a>
            <a id="kb_2" href="javascript:on_numKey(2);" class="weui_grid js_grid grid_height">
                <p class="weui_grid_label font_10">2</p>
            </a>
            <a id="kb_3" href="javascript:on_numKey(3);" class="weui_grid js_grid grid_height">
                <p class="weui_grid_label font_10">3</p>
            </a>
            <a id="kb_4" href="javascript:on_numKey(4);" class="weui_grid js_grid grid_height">
                <p class="weui_grid_label font_10">4</p>
            </a>
            <a id="kb_5" href="javascript:on_numKey(5);" class="weui_grid js_grid grid_height">
                <p class="weui_grid_label font_10">5</p>
            </a>
            <a id="kb_6" href="javascript:on_numKey(6);" class="weui_grid js_grid grid_height">
                <p class="weui_grid_label font_10">6</p>
            </a>
            <a id="kb_7" href="javascript:on_numKey(7);" class="weui_grid js_grid grid_height">
                <p class="weui_grid_label font_10">7</p>
            </a>
            <a id="kb_8" href="javascript:on_numKey(8);" class="weui_grid js_grid grid_height">
                <p class="weui_grid_label font_10">8</p>
            </a>
            <a id="kb_9" href="javascript:on_numKey(9);" class="weui_grid js_grid grid_height">
                <p class="weui_grid_label font_10">9</p>
            </a>
            <a id="kb_null" href="javascript:javascript:window.location='./my_info_transaction_detail.html';" class="weui_grid js_grid grid_height">
                <p class="weui_grid_label font_10" style="visibility:hidden;">0</p>
            </a>
            <a id="kb_0" href="javascript:on_numKey(0);" class="weui_grid js_grid grid_height">
                <p class="weui_grid_label font_10">0</p>
            </a>
            <a id="kb_del" href="javascript:on_numKey(-1);" class="weui_grid js_grid grid_height">
                <p class="weui_grid_label font_10">
                    <img src="../common/del.png" />
                </p>
            </a>
        </div>
    </div>    

    <div id="pwd" class="pwd_pos" style="display:none;background:white;z-index:1003;">
        <div class="weui_panel">
          <div class="weui_panel_bd">
            <div href="javascript:void(0);" class="weui_media_box weui_media_appmsg" style="padding-top:0px;padding-bottom:0px;">
              <div class="weui_media_hd" style="width:20%;">
                    <img class="weui_media_appmsg_thumb" src="../common/del.png" onclick="on_close();" alt="" style="width:20%;">
                    <img class="weui_media_appmsg_thumb" src="../common/pic_del_mark.png" alt="" style="width:60%;">
              </div>
              <div class="weui_media_bd">
                <h4 class="weui_media_title">请输入支付密码</h4>
              </div>
            </div>

            <a href="javascript:void(0);" class="weui_media_box weui_media_appmsg">
              <div class="weui_media_bd" style="text-align:center;">
                <p class="font_8">支付</p>
                <p id="pay_amount" class="font_20"></p>
                <div class="" style="height:3em;line-height:3em;overflow:hidden;border:1px solid black;text-align:center;">
                    <span id="pwd_content" class="font_20" style="height:3em;"></span>
                </div>
              </div>
            </a>
          </div>
        </div>
    </div>    
 -->

</body>

    <script type="text/javascript">

        // //显示遮罩层    
        // function showPayPage() {

        //     //
        //     var total_amount = 0;

        //     $("input[name='product']").each(function(key, value) {

        //         for( var i = 0; i < g_products_info.data.all.length; i++ ) {
        //             if( g_products_info.data.all[i].id == value.id ) {
        
        //                 alert("value.value:" + JSON.stringify(value.value));
        //                 total_amount += parseInt(value.value) * g_products_info.data.all[i].price;
        //                 break;
        //             }
        //         }
        //     });

        //     var total_amount_str = (total_amount/100).toFixed(2);           
        //     $('#pay_amount').html(total_amount_str);


        //     //
        //     $("#mask").css("height",$(document).height());
        //     $("#mask").css("width",$(document).width());
        //     $("#mask").show();

        //     //
        //     $("#keyboard").show();

        //     //
        //     $("#pwd").show();

        //     //
        //     $('#pwd_content').html('');
        //     g_pwd = '';

        // }

        // function change_pwd() {
        //     var src = $('#pwd_content').html();
        //     var dst = '';
        //     for( var i = 0; i < src.length; i++ ) {
        //         dst += '*';
        //     }
        //     $('#pwd_content').html(dst);

        //     clearTimeout(g_timer);
        //     g_timer = null;
        // }

        // function on_numKey(val) {
        //     if( g_timer != null ) {
        //         clearTimeout(g_timer);
        //         g_timer = null;
        //         change_pwd();
        //     }

        //     if( val != -1 ) {
        //         g_pwd += '' + val;
        //         $('#pwd_content').html($('#pwd_content').html() + val);
        //         g_timer = setTimeout(change_pwd,500);
        //     } else {
        //         if( g_pwd.length > 0 ) {
        //             g_pwd = g_pwd.slice(0, g_pwd.length - 1);
        //         }

        //         var dst = '';
        //         for( var i = 0; i < g_pwd.length; i++ ) {
        //             dst += '*';
        //         }
        //         $('#pwd_content').html(dst);
        //     }

        //     console.log('g_pwd:' + g_pwd);
        // }

        // function on_close() {
        //     $('#pwd_content').html('');
        //     g_pwd = '';

        //     $("#mask").hide();
        //     $("#keyboard").hide();
        //     $("#pwd").hide();
        // } 

        // 对Date的扩展，将 Date 转化为指定格式的String   
        // 月(M)、日(d)、小时(h)、分(m)、秒(s)、季度(q) 可以用 1-2 个占位符，   
        // 年(y)可以用 1-4 个占位符，毫秒(S)只能用 1 个占位符(是 1-3 位的数字)   
        // 例子：   
        // (new Date()).Format("yyyy-MM-dd hh:mm:ss.S") ==> 2006-07-02 08:09:04.423   
        // (new Date()).Format("yyyy-M-d h:m:s.S")      ==> 2006-7-2 8:9:4.18   
        Date.prototype.Format = function(fmt)   
        { //author: meizz   
          var o = {   
            "M+" : this.getMonth()+1,                 //月份   
            "d+" : this.getDate(),                    //日   
            "h+" : this.getHours(),                   //小时   
            "m+" : this.getMinutes(),                 //分   
            "s+" : this.getSeconds(),                 //秒   
            "q+" : Math.floor((this.getMonth()+3)/3), //季度   
            "S"  : this.getMilliseconds()             //毫秒   
          };   
          if(/(y+)/.test(fmt))   
            fmt=fmt.replace(RegExp.$1, (this.getFullYear()+"").substr(4 - RegExp.$1.length));   
          for(var k in o)   
            if(new RegExp("("+ k +")").test(fmt))   
          fmt = fmt.replace(RegExp.$1, (RegExp.$1.length==1) ? (o[k]) : (("00"+ o[k]).substr((""+ o[k]).length)));   
          return fmt;   
        }  

        $(document).ready(function(){

            // alert('ready start:' + JSON.stringify(g_products_info));
            
            //
            if( g_products_info ) {

                for( var kind = 0; kind < 2; kind++ ) {

                    var obj;
                    if( kind == 0 ) {
                        obj = g_products_info.data.own;
                    } else if( kind == 1 ) {
                        obj = g_products_info.data.all;
                    }

                    obj.forEach(function(v, i) {

                        // alert('forEach v:' + JSON.stringify(v));

                        var strHtml = '';

                        strHtml += '<div class="weui_panel">';
                        strHtml += '    <div class="weui_panel_bd">';
                        strHtml += '        <div class="weui_media_box weui_media_appmsg">';
                        strHtml += '            <div class="weui_media_hd">';
                        if( v.pics.length > 0 ) {
                            strHtml += '            <img class="weui_media_appmsg_thumb" src="' + v.pics[0] + '" alt="prod">';
                        } else {
                            strHtml += '            <img class="weui_media_appmsg_thumb" src="../common/product.png" style="width:3em;" alt="prod">';
                        }
                        strHtml += '            </div>';
                        strHtml += '            <div class="weui_media_bd">';
                        strHtml += '               <h4 class="weui_media_desc ">';
                        strHtml += '                    <span>' + v.name + '</span>';
                        strHtml += '                </h4>';
                        strHtml += '                <p class="weui_media_desc ">';
                        strHtml += '                    <span>' + v.summary + '</span>';
                        strHtml += '                </p>';
                        strHtml += '                <br>';
                        strHtml += '            </div>';
                        if( v.price ) {

                            strHtml += '        <div class="weui_media_bd" style="margin-left:0px;border-left:0px;padding-left:0px;">';
                            strHtml += '            <br><br><br>';
                            strHtml += '           <p class="weui_media_desc" style="text-align:right;">';
                            strHtml += '                <span id="edit_time">¥ ' + (v.price/100).toFixed(2) + '元</span>';
                            strHtml += '            </p>';
                            strHtml += '        </div>';
                        }
                        strHtml += '        </div>';

                        strHtml += '        <div class="weui_media_box weui_media_appmsg">';
                        strHtml += '            <div class="weui_media_bd" style="text-align:left;">';
                        if( v.expire_time ) {
                            strHtml += '            <p class="weui_media_desc ">';
                            strHtml += '                <span style="color:orange;">' + v.expire_time.slice(0, 10) + ' 到期</span>';
                            strHtml += '            </p>';                            
                        }
                        strHtml += '            </div>';
                        if( v.price ) {
                            strHtml += '        <div class="weui_cell_ft">';
                            strHtml += '            <input id="' + v.id + '" name="product" type="text" class="spinner"/>';
                            strHtml += '        </div>';
                        }
                        strHtml += '        </div>';
                        strHtml += '    </div>';
                        strHtml += '</div>';

                        if( kind == 0 ) {
                            $('#own_container').append(strHtml);
                        } else if( kind == 1 ) {
                            $('#all_container').append(strHtml);
                        }
                    });
                }
            }

            //
            $('.spinner').spinner();

            $("input[name='product']").each(function(key, value) {
                value.value = "0";
            });

        });

        function send_pay() {

            var req_json = {
                orders:[],
                price:0
            };

            $("input[name='product']").each(function(key, value) {

                for( var i = 0; i < g_products_info.data.all.length; i++ ) {
    
                    if( g_products_info.data.all[i].id == value.id ) {
        
                        req_json.price += parseInt(value.value) * g_products_info.data.all[i].price;

                        var order = {
                            goods:g_products_info.data.all[i].id,
                            count:parseInt(value.value),
                            price:g_products_info.data.all[i].price,
                        };

                        req_json.orders.push(order);
                        break;
                    }
                }
            });

            // alert("send_pay() req_json:" + JSON.stringify(req_json));

            if( req_json.orders.length == 0 ) {
                alert("您尚未选择商品");
                return ;
            }

            //
            $.ajax({
              dataType:'json',
              contentType: "application/json",
              type: 'post', // 提交方式 get/post
              url: '/api/v1/personal_info/pay', // 需要提交的 url
              data: JSON.stringify(req_json),
              async: false,
              beforeSend: function(XHR) {
              },
              success: function(data) { // data 保存提交后返回的数据，一般为 json 数据
                // alert("personal_info/pay data:" + JSON.stringify(data));
                if( typeof data == "object" ) {
                    if( data.success == 0 ) {
                        // alert("data.data.pay_url:" + data.data.pay_url);
                        window.location = data.data.pay_url;
                    } else {
                        debug_trace("personal_info/pay success [" + data.success + "]");
                        // window.location = '../common/invalid.html?msg=' + encodeURI(encodeURI('取得家长数据失败，无法取得数据'));
                    }
                } else {
                    debug_trace("personal_info/pay format error");
                    // window.location = '../common/invalid.html?msg=' + encodeURI(encodeURI('取得家长数据失败，格式错误'));
                }
              },
              error:function(XHR, ErrText, Exception) {
                debug_trace("personal_info/pay failure.");
                // window.location = '../common/invalid.html?msg=' + encodeURI(encodeURI('取得家长数据失败，服务器连接错误'));
              }
            });


        } 

    </script> 

</html>
